<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content HTML Purifier</title>
    <meta name="description" content="A custom HTML editor that purifies content by removing extra HTML, inline styles, and redundant tags, creating clean, semantic HTML.">
    <meta name="keywords" content="HTML purifier, content editor, clean HTML, semantic HTML, web editor">
    <meta name="author" content="Rakib Alom">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Content HTML Purifier">
    <meta property="og:description" content="Clean and purify HTML content from Google Docs or websites with this custom editor.">
    <meta property="og:image" content="img/content-html-purifier.png">
    <meta property="og:url" content="img/content-html-purifier.png">
    <meta property="og:type" content="website">
    <link rel="icon" href="img/favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #editor > *:first-child {
            margin-top: 0 !important;
        }
        #editor p {
            margin-bottom: 0.75em;
            font-weight: normal;
        }
        #editor h1, #editor h2, #editor h3, #editor h4, #editor h5, #editor h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            font-weight: bold;
            color: #1a202c;
        }
        #editor h1 { font-size: 2em; }
        #editor h2 { font-size: 1.75em; }
        #editor h3 { font-size: 1.5em; }
        #editor h4 { font-size: 1.25em; }
        #editor h5 { font-size: 1.125em; }
        #editor h6 { font-size: 1em; }
        #editor ul {
            margin-left: 2em;
            margin-bottom: 0.75em;
            list-style-type: disc;
        }
        #editor ol {
            margin-left: 2em;
            margin-bottom: 0.75em;
            list-style-type: decimal;
        }
        #editor li { margin-bottom: 0.25em; }
        #editor a { color: #3b82f6; text-decoration: underline; }
        #editor strong, #editor b { font-weight: bold; }
        #editor em, #editor i { font-style: italic; }
        #editor u { text-decoration: underline; }
        #editor blockquote {
            border-left: 4px solid #ccc;
            padding-left: 1em;
            margin-left: 1em;
            color: #555;
            font-style: italic;
        }
        #editor pre {
            background-color: #f0f0f0;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Cascadia Code', 'Roboto Mono', monospace;
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.hidden {
            transform: translateX(-100%);
        }
        .active-note {
            background-color: #374151 !important; /* Tailwind blue-600 */
            color: white !important;
            font-weight: 600;
        }
        .active-note:hover {
            background-color: #1d4ed8; /* Tailwind blue-700 (deeper color) */
        }
        #helpModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        #helpModalContent {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a202c;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh; /* Increased height to accommodate full video */
            overflow-y: auto;
            color: #d1d5db;
        }
        #helpModalContent h1 { font-size: 2em; margin-bottom: 0.5em; }
        #helpModalContent h2 { font-size: 1.5em; margin-top: 1em; margin-bottom: 0.5em; }
        #helpModalContent ol { margin-left: 1.5em; margin-bottom: 1em; }
        #helpModalContent li { margin-bottom: 0.5em; }
        #helpModalContent video { width: 100%; margin-top: 1em; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden font-sans bg-gray-900 text-gray-300">
    <div class="flex flex-col md:flex-row h-full w-full">
        <button id="menuToggle" class="md:hidden fixed top-4 left-4 z-[1100] text-white text-2xl bg-gray-800 p-2 rounded hover:bg-gray-700 transition-colors">â˜°</button>
        <div id="sidebar" class="fixed md:static top-0 left-0 w-64 md:w-[250px] md:min-w-[250px] bg-gray-800 border-r md:border-r border-gray-600 p-4 flex flex-col justify-between gap-4 overflow-y-auto h-full z-[1000]">
            <div class="flex flex-col gap-4">
                <div class="flex justify-center md:justify-between items-center">
                    <span id="notesTitle" class="text-xl font-semibold text-white cursor-pointer" onclick="loadMainPage()">Notes</span>
                    <button id="closeSidebar" class="md:hidden text-white text-xl p-2 rounded hover:bg-gray-700 transition-colors">Ã—</button>
                </div>
                <button class="w-full bg-blue-500 text-white py-2 px-4 rounded font-semibold cursor-pointer text-center hover:bg-blue-600 transition-colors" onclick="createNewNote()">New Note</button>
                <ul id="noteList" class="list-none p-0 m-0 flex-grow"></ul>
            </div>
            <div class="pt-4 border-t border-gray-600 text-center">
                <button id="helpDocsBtn" class="w-full bg-gray-700 text-white py-2 px-4 rounded font-semibold cursor-pointer hover:bg-gray-600 transition-colors">Help & Docs</button>
                <small class="mt-2 block text-xs text-gray-400">Developed by <a href="https://rakibalom.com/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-600 hover:underline font-medium">Rakib Alom</a></small>
            </div>
        </div>
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[900] hidden md:hidden"></div>

        <div id="mainContent" class="flex-grow flex flex-col p-2 md:p-4 pt-12 md:pt-4 overflow-y-auto">
            <header class="text-center mb-6">
                <h1 class="text-4xl font-extrabold text-white">Content HTML Purifier ðŸš€</h1>
                <p class="text-lg text-gray-400 mt-2">This custom editor cleans HTML. Paste content from Google Docs or any website; it will remove extra HTML, inline styles, and redundant tags, leaving professional, semantic HTML.</p>
            </header>
            
            <div class="editor-container relative flex flex-col rounded overflow-hidden border border-gray-600 bg-gray-800 shadow-md flex-grow max-w-full z-[500]">
                <div class="navbar-toolbar flex items-center justify-between p-3 bg-gray-700 border-b border-gray-600 gap-2 flex-wrap">
                    <div class="format-buttons flex gap-2 flex-wrap">
                        <select id="formatBlock" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">
                            <option value="p">Normal</option>
                            <option value="h1">Heading 1</option>
                            <option value="h2">Heading 2</option>
                            <option value="h3">Heading 3</option>
                            <option value="h4">Heading 4</option>
                            <option value="h5">Heading 5</option>
                            <option value="h6">Heading 6</option>
                            <option value="blockquote">Blockquote</option>
                            <option value="pre">Code</option>
                        </select>
                        <button type="button" onclick="execCmd('bold')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors"><b>B</b></button>
                        <button type="button" onclick="execCmd('italic')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors"><i>I</i></button>
                        <button type="button" onclick="execCmd('underline')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors"><u>U</u></button>
                        <button type="button" onclick="execCmd('insertUnorderedList')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">&#8226; List</button>
                        <button type="button" onclick="execCmd('insertOrderedList')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">1. List</button>
                        <button type="button" id="createLinkBtn" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Link</button>
                        <button type="button" onclick="execCmd('unlink')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Unlink</button>
                        <button type="button" onclick="execCmd('insertImage')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Image</button>
                        <button type="button" onclick="execCmd('removeFormat')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Clear Format</button>
                        <button type="button" onclick="execCmd('formatBlock', 'blockquote')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Blockquote</button>
                        <button type="button" onclick="execCmd('formatBlock', 'pre')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Code</button>
                        <button type="button" onclick="execCmd('formatBlock', 'p')" class="bg-gray-800 border border-gray-600 text-gray-300 px-3 py-2 rounded-sm text-sm cursor-pointer hover:bg-gray-900 hover:border-blue-500 transition-colors">Remove Blockquote/Code</button>
                    </div>
                    <div class="source-toggle-wrapper">
                        <button id="toggleSource" class="bg-blue-500 text-white px-3.5 py-2 rounded-sm text-sm font-semibold hover:bg-blue-600 transition-colors">Show Source Code</button>
                    </div>
                </div>
                <div id="editor" class="flex-grow p-6 outline-none overflow-y-auto bg-white text-gray-800 break-words text-base leading-relaxed text-left max-w-full font-sans font-normal" contenteditable="true"></div>

                <div id="linkEditor" class="absolute bg-gray-700 border border-gray-600 rounded p-2 flex gap-2 shadow-md z-[1000] opacity-0 pointer-events-none transition-opacity duration-200 ease-in-out translate-y-2.5">
                    <input type="url" id="linkUrlInput" placeholder="https://example.com" class="flex-grow px-2 py-1 border border-gray-600 rounded text-gray-300 bg-gray-800 outline-none min-w-[150px] placeholder-gray-400" />
                    <button id="linkUpdateButton" title="Update Link" class="bg-blue-500 text-white px-2 py-1 rounded cursor-pointer hover:bg-blue-600 transition-colors">&#10003;</button>
                    <button id="linkRemoveButton" title="Remove Link" class="bg-red-500 text-white px-2 py-1 rounded cursor-pointer hover:bg-red-600 transition-colors">&#10006;</button>
                </div>
            </div>

            <div id="sourceCode" class="relative flex flex-col rounded overflow-hidden border border-gray-600 bg-gray-800 shadow-md flex-grow max-w-full hidden">
                <h2 class="bg-gray-700 text-white p-3 text-lg font-semibold rounded-t border-b border-gray-600">Purified HTML Source Code</h2>
                <textarea id="sourceCodeTextarea" class="flex-grow p-4 border-none font-mono text-sm leading-relaxed bg-gray-900 text-gray-300 resize-y outline-none rounded-b"></textarea>
                <div class="flex justify-end p-3 bg-gray-700 rounded-b border-b border-gray-600">
                    <button id="applySource" class="bg-blue-500 text-white px-6 py-3 rounded font-semibold cursor-pointer hover:bg-blue-600 transition-colors">Apply Changes & Hide Source</button>
                </div>
            </div>
        </div>

        <div id="helpModal" class="hidden">
            <div id="helpModalContent">
                <h1>How to Use Content HTML Purifier</h1>
                <p class="mt-2">This tool helps you clean and purify HTML content from sources like Google Docs or websites. Follow these steps to get started:</p>
                <ol class="mt-4">
                    <li><strong>Access the Editor</strong>: Open the tool and ensure the sidebar is visible (toggle with â˜° on mobile).</li>
                    <li><strong>Create a New Note</strong>: Click "New Note" to start a fresh document.</li>
                    <li><strong>Paste Content</strong>: Copy content from Google Docs or a website and paste it into the editor.</li>
                    <li><strong>Format Text</strong>: Use the toolbar buttons (e.g., Bold, Italic, Lists) to format your content.</li>
                    <li><strong>Purify HTML</strong>: Click "Show Source Code" to view and apply a cleaned version of your HTML.</li>
                    <li><strong>Save Work</strong>: Notes are auto-saved; switch between them using the sidebar.</li>
                    <li><strong>Add Links/Images</strong>: Use the "Link" or "Image" buttons to insert hyperlinks or images.</li>
                    <li><strong>Review Changes</strong>: Use "Help & Docs" for guidance or watch the video below.</li>
                </ol>
                <h2>Tutorial Video</h2>
                <video controls width="100%">
                    <source src="https://github.com/RakibAlom/content-html-purifier/raw/refs/heads/main/content-html-purifier-tool-review.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const toggleSourceButton = document.getElementById('toggleSource');
        const sourceCodeDiv = document.getElementById('sourceCode');
        const sourceCodeTextarea = document.getElementById('sourceCodeTextarea');
        const applySourceButton = document.getElementById('applySource');
        const editorVisualContainer = document.querySelector('.editor-container');
        const formatBlockSelect = document.getElementById('formatBlock');
        const noteList = document.getElementById('noteList');
        const createLinkBtn = document.getElementById('createLinkBtn');
        const linkEditor = document.getElementById('linkEditor');
        const linkUrlInput = document.getElementById('linkUrlInput');
        const linkUpdateButton = document.getElementById('linkUpdateButton');
        const linkRemoveButton = document.getElementById('linkRemoveButton');
        const menuToggle = document.getElementById('menuToggle');
        const closeSidebar = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const mainContent = document.getElementById('mainContent');
        const helpModal = document.getElementById('helpModal');
        const helpModalContent = document.getElementById('helpModalContent');
        const notesTitle = document.getElementById('notesTitle');
        const helpDocsBtn = document.getElementById('helpDocsBtn');

        let notes = [];
        let currentNoteId = null;
        let isInitialLoad = true;
        let currentRange = null;
        let currentLinkElement = null;

        function toggleSidebar() {
            sidebar.classList.toggle('hidden');
            overlay.classList.toggle('hidden');
            if (!sidebar.classList.contains('hidden')) {
                editor.focus();
            }
        }

        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });
        closeSidebar.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!sidebar.classList.contains('hidden')) {
                toggleSidebar();
            }
            hideHelpModal();
        });

        function saveNotes() {
            try {
                console.log('Saving notes:', notes);
                localStorage.setItem('htmlPurifierNotes', JSON.stringify(notes));
            } catch (e) {
                console.error('Error saving notes to localStorage:', e);
            }
        }

        function loadNotes() {
            try {
                console.log('Loading notes from localStorage');
                const storedNotes = localStorage.getItem('htmlPurifierNotes');
                if (storedNotes) {
                    notes = JSON.parse(storedNotes);
                    console.log('Loaded notes:', notes);
                } else {
                    notes = [];
                    console.log('No stored notes found, initializing empty array');
                }

                if (notes.length > 0) {
                    currentNoteId = notes[0].id;
                    editor.innerHTML = notes[0].content || '<p></p>';
                    console.log('Loaded note into editor:', notes[0]);
                } else {
                    console.log('No notes, creating new note');
                    createNewNote(true);
                }
                renderNoteList();
                isInitialLoad = false;
            } catch (e) {
                console.error('Error loading notes from localStorage:', e);
                notes = [];
                console.log('Creating fallback note due to error');
                createNewNote(true);
            }
        }

        function createNewNote(activateImmediately = true) {
            if (!isInitialLoad && currentNoteId !== null) {
                saveCurrentNoteContent();
            }

            const newNote = {
                id: Date.now().toString(),
                title: `New Note ${notes.length + 1}`,
                content: '<p></p>'
            };
            notes.push(newNote);
            console.log('Created new note:', newNote);
            saveNotes();
            
            if (activateImmediately) {
                currentNoteId = newNote.id;
                editor.innerHTML = newNote.content;
                console.log('Activated new note:', newNote.id);
            }
            renderNoteList();
        }

        function saveCurrentNoteContent() {
            if (currentNoteId !== null && !isInitialLoad) {
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex !== -1) {
                    notes[noteIndex].content = editor.innerHTML;
                    console.log('Saved note content for ID:', currentNoteId);
                    saveNotes();
                }
            }
        }

        function loadNoteIntoEditor(id) {
            if (!isInitialLoad && currentNoteId !== null && currentNoteId !== id) {
                saveCurrentNoteContent();
            }
           
            currentNoteId = id;
            const note = notes.find(n => n.id === id);
            if (note) {
                editor.innerHTML = note.content || '<p></p>';
                console.log('Loaded note into editor:', note);
                renderNoteList();
            }
            isInitialLoad = false;
            hideLinkEditor();
            if (window.innerWidth < 768) toggleSidebar();
            hideHelpModal();
        }

        function renderNoteList() {
            console.log('Rendering note list with notes:', notes);
            noteList.innerHTML = '';
            if (notes.length === 0) {
                noteList.innerHTML = '<li class="text-gray-400 py-2 px-2">No notes available</li>';
                console.log('No notes to render, showing placeholder and creating new note');
                createNewNote(true);
                return;
            }

            notes.forEach(note => {
                const li = document.createElement('li');
                li.className = `flex justify-between items-center py-2 px-2 rounded mb-2 bg-transparent text-gray-300 cursor-pointer transition-colors overflow-hidden whitespace-nowrap text-ellipsis hover:bg-gray-700 ${note.id === currentNoteId ? 'active-note' : ''}`;
                li.setAttribute('data-id', note.id);

                const noteNameSpan = document.createElement('span');
                noteNameSpan.className = 'flex-grow pr-2 overflow-hidden text-ellipsis';
                noteNameSpan.textContent = note.title;
                noteNameSpan.onclick = () => loadNoteIntoEditor(note.id);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-1 flex-shrink-0';

                const renameBtn = document.createElement('button');
                renameBtn.innerHTML = '&#9998;';
                renameBtn.title = 'Rename Note';
                renameBtn.className = 'bg-transparent border-none text-gray-400 cursor-pointer text-sm p-1 rounded hover:text-white hover:bg-gray-600 transition-colors';
                renameBtn.onclick = (e) => {
                    e.stopPropagation();
                    renameNote(note.id);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&#128465;';
                deleteBtn.title = 'Delete Note';
                deleteBtn.className = 'bg-transparent border-none text-gray-400 cursor-pointer text-sm p-1 rounded hover:text-red-500 hover:bg-gray-600 transition-colors';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteNote(note.id);
                };

                actionsDiv.appendChild(renameBtn);
                actionsDiv.appendChild(deleteBtn);

                li.appendChild(noteNameSpan);
                li.appendChild(actionsDiv);
                noteList.appendChild(li);
            });
        }

        function renameNote(id) {
            const note = notes.find(n => n.id === id);
            if (note) {
                const newTitle = prompt('Enter new note title:', note.title);
                if (newTitle !== null && newTitle.trim() !== '') {
                    note.title = newTitle.trim();
                    saveNotes();
                    renderNoteList();
                }
            }
        }

        function deleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                const indexToDelete = notes.findIndex(n => n.id === id);
                if (indexToDelete !== -1) {
                    notes.splice(indexToDelete, 1);
                    saveNotes();

                    if (currentNoteId === id) {
                        if (notes.length > 0) {
                            currentNoteId = notes[0].id;
                            loadNoteIntoEditor(currentNoteId);
                        } else {
                            currentNoteId = null;
                            editor.innerHTML = '<p></p>';
                            createNewNote(true);
                        }
                    }
                    renderNoteList();
                }
            }
        }

        function execCmd(command, value = null) {
            editor.focus();
            hideLinkEditor();

            try {
                if (command === 'createLink') {
                    showLinkEditor('new');
                    return;
                } else if (command === 'insertUnorderedList' || command === 'insertOrderedList') {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const listType = command === 'insertUnorderedList' ? 'ul' : 'ol';
                        const list = document.createElement(listType);
                        const li = document.createElement('li');
                        const selectedContent = range.extractContents();
                        li.appendChild(selectedContent);
                        list.appendChild(li);
                        range.insertNode(list);
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(li);
                        selection.addRange(newRange);
                    }
                } else if (command === 'unlink') {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const anchor = range.commonAncestorContainer;
                        const link = anchor.nodeType === Node.ELEMENT_NODE ? anchor.closest('a') : anchor.parentElement.closest('a');
                        if (link) {
                            const content = link.textContent;
                            const textNode = document.createTextNode(content);
                            link.parentNode.replaceChild(textNode, link);
                            selection.removeAllRanges();
                            const newRange = document.createRange();
                            newRange.selectNodeContents(textNode);
                            selection.addRange(newRange);
                        }
                    }
                } else if (command === 'insertImage') {
                    const url = prompt('Enter image URL:');
                    if (url) {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = 'Image';
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            selection.getRangeAt(0).insertNode(img);
                        } else {
                            editor.appendChild(img);
                        }
                    }
                } else if (command === 'removeFormat') {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const fragment = range.extractContents();
                        const text = fragment.textContent;
                        const textNode = document.createTextNode(text);
                        range.insertNode(textNode);
                        selection.removeAllRanges();
                        const newRange = document.createRange();
                        newRange.selectNodeContents(textNode);
                        selection.addRange(newRange);
                    }
                } else {
                    document.execCommand(command, false, value);
                }
                updateFormatBlockSelect();
                saveCurrentNoteContent();
            } catch (e) {
                console.error(`Error executing command ${command}:`, e);
            }
        }

        formatBlockSelect.addEventListener('change', () => {
            execCmd('formatBlock', formatBlockSelect.value);
        });

        function updateFormatBlockSelect() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                let node = selection.getRangeAt(0).startContainer;
                while (node && node !== editor && node.nodeType === Node.ELEMENT_NODE && !['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'pre'].includes(node.tagName.toLowerCase())) {
                    node = node.parentNode;
                }
                if (node && node !== editor && ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'pre'].includes(node.tagName.toLowerCase())) {
                    formatBlockSelect.value = node.tagName.toLowerCase();
                } else {
                    formatBlockSelect.value = 'p';
                }
            }
        }

        editor.addEventListener('mouseup', (event) => {
            updateFormatBlockSelect();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                currentRange = selection.getRangeAt(0);
            }
            const target = event.target;
            if (target.tagName.toLowerCase() === 'a' && editor.contains(target)) {
                showLinkEditor('edit', target);
            } else {
                hideLinkEditor();
            }
        });

        editor.addEventListener('keyup', (event) => {
            updateFormatBlockSelect();
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                currentRange = selection.getRangeAt(0);
            }
            hideLinkEditor();
        });

        let cleanupTimeout;
        editor.addEventListener('input', () => {
            saveCurrentNoteContent();
            clearTimeout(cleanupTimeout);
            cleanupTimeout = setTimeout(() => {
                cleanEmptyBlockTags();
            }, 300);
        });

        editor.addEventListener('paste', (event) => {
            event.preventDefault();

            const html = (event.clipboardData || window.clipboardData).getData('text/html');
            const text = (event.clipboardData || window.clipboardData).getData('text/plain');

            let contentToInsert;

            if (html) {
                contentToInsert = purifyHtml(html);
            } else {
                contentToInsert = text.split('\n')
                                      .map(line => line.trim())
                                      .filter(line => line.length > 0)
                                      .map(line => `<p>${line}</p>`)
                                      .join('');
                if (text.trim() === '') contentToInsert = '<p></p>';
                contentToInsert = purifyHtml(contentToInsert);
            }

            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const div = document.createElement('div');
                div.innerHTML = contentToInsert;
                while (div.firstChild) {
                    range.insertNode(div.firstChild);
                }
            } else {
                editor.innerHTML = contentToInsert;
            }
            editor.innerHTML = purifyHtml(editor.innerHTML);
            saveCurrentNoteContent();
        });

        function purifyHtml(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            const body = doc.body;

            const comments = [];
            const iterator = doc.createNodeIterator(body, NodeFilter.SHOW_COMMENT);
            let commentNode;
            while ((commentNode = iterator.nextNode())) { comments.push(commentNode); }
            comments.forEach(comment => comment.parentNode.removeChild(comment));

            Array.from(body.querySelectorAll('*')).forEach(element => {
                const tagName = element.tagName.toLowerCase();
                const styleAttr = element.getAttribute('style') || '';
                const isBold = styleAttr.match(/font-weight:\s*(bold|700|800|900)/i) ||
                               (element.style && element.style.fontWeight && element.style.fontWeight.match(/bold|700|800|900/i));
                const isItalic = styleAttr.match(/font-style:\s*italic/i) ||
                               (element.style && element.style.fontStyle && element.style.fontStyle.match(/italic/i));

                if (!['b', 'strong'].includes(tagName) && isBold && element.textContent.trim() !== '') {
                    const strong = doc.createElement('strong');
                    while (element.firstChild) {
                        strong.appendChild(element.firstChild);
                    }
                    if (element.parentNode) {
                        element.parentNode.replaceChild(strong, element);
                    }
                }
                if (!['i'].includes(tagName) && isItalic && element.textContent.trim() !== '') {
                    const i = doc.createElement('i');
                    while (element.firstChild) {
                        i.appendChild(element.firstChild);
                    }
                    if (element.parentNode) {
                        element.parentNode.replaceChild(i, element);
                    }
                }
            });

            const attributesToRemove = [
                'style', 'class', 'id', 'data-mce-style', 'data-font-weight', 'lang', 'dir',
                'align', 'valign', 'border', 'cellspacing', 'cellpadding', 'width', 'height',
                'background', 'bgcolor', 'color', 'face', 'size', 'role', 'aria-hidden',
                'tabindex', 'itemprop', 'itemscope', 'itemtype', 'xml:lang', 'contenteditable'
            ];

            Array.from(body.querySelectorAll('*')).forEach(element => {
                const tagName = element.tagName.toLowerCase();

                if (tagName === 'a') {
                    Array.from(element.attributes).forEach(attr => {
                        if (!['href', 'target', 'title', 'rel'].includes(attr.name)) {
                            element.removeAttribute(attr.name);
                        }
                    });
                }
                else if (tagName === 'img') {
                    Array.from(element.attributes).forEach(attr => {
                        if (!['src', 'alt', 'title'].includes(attr.name)) {
                            element.removeAttribute(attr.name);
                        }
                    });
                }
                else if (tagName === 'b' || tagName === 'strong' || tagName === 'i') {
                    Array.from(element.attributes).forEach(attr => {
                        element.removeAttribute(attr.name);
                    });
                }
                else {
                    attributesToRemove.forEach(attr => element.removeAttribute(attr));
                }
            });

            const tagsToUnwrap = ['font', 'center', 'span', 'em'];
            tagsToUnwrap.forEach(tagName => {
                Array.from(body.querySelectorAll(tagName)).forEach(element => {
                    if (element.attributes.length === 0 && element.textContent.trim() !== '' && !['i'].includes(tagName)) {
                        while (element.firstChild) {
                            element.parentNode.insertBefore(element.firstChild, element);
                        }
                        element.parentNode.removeChild(element);
                    }
                });
            });

            const blockTags = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'div', 'td', 'th'];
            const inlineTagsThatCanBeEmpty = ['a', 'i', 's', 'u'];

            const allContentElements = Array.from(body.querySelectorAll(
                [...blockTags, ...inlineTagsThatCanBeEmpty, 'b', 'strong', 'i'].join(',')
            )).reverse();

            allContentElements.forEach(element => {
                const tagName = element.tagName.toLowerCase();
                const isBlockTag = blockTags.includes(tagName);

                const hasMeaningfulContent = Array.from(element.childNodes).some(node =>
                    (node.nodeType === Node.TEXT_NODE && node.nodeValue.trim().length > 0) ||
                    (node.nodeType === Node.ELEMENT_NODE && !['br', 'img', 'hr'].includes(node.tagName.toLowerCase()) && node.textContent.trim().length > 0)
                );

                if (!hasMeaningfulContent && element.children.length === 0 && element.parentNode) {
                    if (tagName === 'b' || tagName === 'strong' || tagName === 'i') {
                        if (element.textContent.trim() === '') {
                            element.parentNode.removeChild(element);
                        }
                    } else if (isBlockTag || inlineTagsThatCanBeEmpty.includes(tagName)) {
                        element.parentNode.removeChild(element);
                    }
                }
            });

            body.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li, blockquote, td, th').forEach(block => {
                while (block.firstChild && block.firstChild.nodeName === 'BR') {
                    block.removeChild(block.firstChild);
                }
                while (block.lastChild && block.lastChild.nodeName === 'BR') {
                    block.removeChild(block.lastChild);
                }
            });

            let finalHtml = body.innerHTML;
            finalHtml = finalHtml.replace(/(<br\s*\/?>\s*){2,}/gi, '<br>');
            finalHtml = finalHtml.replace(/<br\s*\/?>\s*(<\/?(p|div|h[1-6]|ul|ol|li|blockquote|table|tr|td|th)>)/gi, '$1');
            finalHtml = finalHtml.replace(/(<\/?(p|div|h[1-6]|ul|ol|li|blockquote|table|tr|td|th)>)\s*<br\s*\/?>/gi, '$1');
            finalHtml = finalHtml.replace(/<p>\s*<br\s*\/?>\s*<\/p>/gi, '<p></p>');

            return finalHtml;
        }

        toggleSourceButton.addEventListener('click', () => {
            if (sourceCodeDiv.style.display === 'none') {
                const currentHtml = editor.innerHTML;
                const purifiedHtml = purifyHtml(currentHtml);
                sourceCodeTextarea.value = formatHtml(purifiedHtml);
                editorVisualContainer.style.display = 'none';
                sourceCodeDiv.style.display = 'flex';
                toggleSourceButton.textContent = 'Hide Source Code';
                hideLinkEditor();
            } else {
                editorVisualContainer.style.display = 'flex';
                sourceCodeDiv.style.display = 'none';
                toggleSourceButton.textContent = 'Show Source Code';

                const newHtml = sourceCodeTextarea.value;
                const purifiedHtml = purifyHtml(newHtml);
                editor.innerHTML = purifiedHtml;
                saveCurrentNoteContent();
            }
        });

        applySourceButton.addEventListener('click', () => {
            const newHtml = sourceCodeTextarea.value;
            const purifiedHtml = purifyHtml(newHtml);
            editor.innerHTML = purifiedHtml;

            editorVisualContainer.style.display = 'flex';
            sourceCodeDiv.style.display = 'none';
            toggleSourceButton.textContent = 'Show Source Code';
            saveCurrentNoteContent();
        });

        function formatHtml(html) {
            let formatted = html.replace(/></g, '>\n<');
            formatted = formatted.replace(/(<\/[a-z]+>)(<[a-z]+>)/g, '$1\n$2');
            formatted = formatted.replace(/(>)(<[a-z])/g, '$1\n$2');
            formatted = formatted.replace(/(\r\n|\n|\r)/gm, '\n').trim();

            let indent = 0;
            const lines = formatted.split('\n');
            let finalHtml = [];
            const indentTags = ['html', 'body', 'div', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'table', 'tr', 'td', 'th', 'blockquote', 'a', 'img', 'span', 'strong', 'em', 'b', 'i', 'pre'];

            lines.forEach(line => {
                const trimmedLine = line.trim();
                let shouldDedent = false;
                let shouldIndent = false;

                if (trimmedLine.startsWith('</') && indent > 0) {
                    const tagNameMatch = trimmedLine.match(/^<\/([a-z]+)/i);
                    if (tagNameMatch && indentTags.includes(tagNameMatch[1].toLowerCase())) {
                        indent--;
                        shouldDedent = true;
                    }
                }

                if (trimmedLine !== '') {
                    finalHtml.push(' '.repeat(indent * 2) + trimmedLine);
                }

                if (trimmedLine.startsWith('<') && !trimmedLine.startsWith('</') && !trimmedLine.endsWith('/>')) {
                    const tagNameMatch = trimmedLine.match(/^<([a-z]+)/i);
                    if (tagNameMatch && indentTags.includes(tagNameMatch[1].toLowerCase()) && !['br', 'img', 'hr'].includes(tagNameMatch[1].toLowerCase())) {
                        shouldIndent = true;
                    }
                }

                if (shouldIndent && !shouldDedent) {
                    indent++;
                }
            });

            return finalHtml.join('\n');
        }

        createLinkBtn.addEventListener('click', () => execCmd('createLink'));

        function showLinkEditor(mode, linkElement = null) {
            currentLinkElement = linkElement;

            if (mode === 'new') {
                linkUrlInput.value = 'https://';
                linkRemoveButton.style.display = 'none';
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    currentRange = selection.getRangeAt(0);
                } else {
                    editor.focus();
                    const range = document.createRange();
                    range.selectNodeContents(editor);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    currentRange = selection.getRangeAt(0);
                }
            } else if (mode === 'edit' && linkElement) {
                linkUrlInput.value = linkElement.href;
                linkRemoveButton.style.display = 'inline-block';
                currentRange = null;
            }

            const editorRect = editor.getBoundingClientRect();
            let rect;

            if (currentLinkElement) {
                rect = currentLinkElement.getBoundingClientRect();
            } else if (currentRange) {
                rect = currentRange.getBoundingClientRect();
                if (rect.width === 0 && rect.height === 0) {
                    const tempSpan = document.createElement('span');
                    tempSpan.textContent = '\uFEFF';
                    currentRange.insertNode(tempSpan);
                    rect = tempSpan.getBoundingClientRect();
                    tempSpan.parentNode.removeChild(tempSpan);
                }
            } else {
                rect = { top: editorRect.top + 20, left: editorRect.left + 20, width: 0, height: 0 };
            }

            const containerRect = editorVisualContainer.getBoundingClientRect();
            let top = rect.top - containerRect.top - linkEditor.offsetHeight - 10;
            let left = rect.left - containerRect.left + (rect.width / 2) - (linkEditor.offsetWidth / 2);

            if (top < 0) top = 10;
            if (left < 0) left = 10;
            if (left + linkEditor.offsetWidth > containerRect.width) left = containerRect.width - linkEditor.offsetWidth - 10;
            if (top + linkEditor.offsetHeight > containerRect.height) top = containerRect.height - linkEditor.offsetHeight - 10;

            linkEditor.style.top = `${top}px`;
            linkEditor.style.left = `${left}px`;
            linkEditor.classList.add('active');
            linkUrlInput.focus();
        }

        function hideLinkEditor() {
            linkEditor.classList.remove('active');
            currentLinkElement = null;
            currentRange = null;
        }

        linkUpdateButton.addEventListener('click', () => {
            const url = linkUrlInput.value.trim();
            if (url) {
                editor.focus();
                if (currentLinkElement) {
                    currentLinkElement.href = url;
                } else if (currentRange) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(currentRange);
                    const selectedText = selection.toString();
                    const anchor = document.createElement('a');
                    anchor.href = url;
                    anchor.textContent = selectedText || 'Link';
                    currentRange.deleteContents();
                    currentRange.insertNode(anchor);
                }
                saveCurrentNoteContent();
            }
            hideLinkEditor();
        });

        linkRemoveButton.addEventListener('click', () => {
            editor.focus();
            if (currentLinkElement) {
                const content = currentLinkElement.textContent;
                const textNode = document.createTextNode(content);
                currentLinkElement.parentNode.replaceChild(textNode, currentLinkElement);
                const selection = window.getSelection();
                selection.removeAllRanges();
                const range = document.createRange();
                range.selectNodeContents(textNode);
                selection.addRange(range);
            }
            saveCurrentNoteContent();
            hideLinkEditor();
        });

        document.addEventListener('mousedown', (event) => {
            const isClickInsideEditor = editor.contains(event.target);
            const isClickInsideLinkEditor = linkEditor.contains(event.target);
            const isClickOnToolbar = editorVisualContainer.querySelector('.navbar-toolbar').contains(event.target);
            const isClickOnSidebar = sidebar.contains(event.target) || menuToggle.contains(event.target);

            if (!isClickInsideEditor && !isClickInsideLinkEditor && !isClickOnToolbar && !isClickOnSidebar) {
                hideLinkEditor();
                if (window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                    toggleSidebar();
                }
            } else if (window.innerWidth < 768 && isClickInsideEditor && !sidebar.classList.contains('hidden')) {
                toggleSidebar();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                hideLinkEditor();
                if (window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                    toggleSidebar();
                }
                hideHelpModal();
            }
        });

        function showMainContent() {
            mainContent.querySelectorAll('#editor, #sourceCode').forEach(el => el.classList.add('hidden'));
            editor.classList.remove('hidden');
            sourceCodeDiv.classList.add('hidden');
            hideHelpModal();
        }

        function showHelpModal() {
            helpModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideHelpModal() {
            helpModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing sidebar');
            loadNotes();
            if (noteList.children.length === 0) {
                console.log('Sidebar empty after load, forcing note creation');
                createNewNote(true);
            }
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
                overlay.classList.add('hidden');
            }
            helpDocsBtn.addEventListener('click', showHelpModal);
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) hideHelpModal();
            });
        });
        window.addEventListener('beforeunload', saveCurrentNoteContent);
    </script>
</body>
</html>